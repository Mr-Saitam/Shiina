const { is_num, saveJSON } = require("../utils/utilidades.js"),
				errorDB = require("../class/errorDB.js");


module.exports = {
	setIndex: function(clave, index, valor, split_object, global_object, self, save) {

    if(!index && index != 0) throw new errorDB(`El segundo parametro debe ser un index(numero)`, 'NUMERO INVALIDO', 'setIndex', clave, index)
    if(!is_num(index)) throw new errorDB(`El segundo parametro debe ser un index(numero)`, 'NUMERO INVALIDO', 'setIndex', clave, index)
    index = parseInt(index)
	  if(!valor && valor != 0) throw new errorDB(`El valor que se usarÃ¡ para remplazar no fue especificado`, 'VALOR INVALIDO', 'setIndex', clave, index)

	  var [...args] = clave.split(split_object)
	  var object_data = global_object[self.object_id]

		for(var key of args) {
			if(!object_data.hasOwnProperty(key)) return Promise.reject(new errorDB(`No se encontro la propiedad ${key}, base de datos: ${self.database_name}`, 'PROPIEDAD NO EXISTENTE', 'setIndex', clave, index))
			if(key == args[args.length-1]) {
				if(!Array.isArray(object_data[key])) return Promise.reject(new errorDB(`El valor de la propiedad ${key} no es un array, base de datos: ${self.database_name}`, 'ARRAY NO EXISTENTE', 'setIndex', clave, index))
				if(index >= object_data[key].length) return Promise.reject(new errorDB(`El item con el indice ${index} no existe en el array ${key}, base de datos: ${self.database_name}`, 'ITEM NO EXISTENTE', 'setIndex', clave, index))
				object_data[key][index] = valor
				if(!save) return Promise.resolve(object_data[key])
				saveJSON(self, global_object[self.object_id])
				return Promise.resolve(object_data[key])			
			}
			else {
				object_data = object_data[key]
			}
		}
	}
}